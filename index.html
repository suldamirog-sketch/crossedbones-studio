<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIHB Pro Generator v1 </title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@700&family=Russo+One&family=Teko:wght@700&family=Anton&family=Black+Ops+One&family=Permanent+Marker&family=Righteous&family=Staatliches&family=Passion+One:wght@700&family=Montserrat:wght@900&family=Impact&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 42px;
            background: linear-gradient(45deg, #ff0844, #ffb199);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
        }

        .controls-panel {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .controls-panel::-webkit-scrollbar {
            width: 10px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 10px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #ff0844;
            border-radius: 10px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #2a2a2a;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff0844;
            margin-bottom: 18px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #ff0844;
            background: #333;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 2px dashed #3a3a3a;
            border-radius: 8px;
            cursor: pointer;
            color: #999;
            font-size: 13px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #3a3a3a;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #ff0844;
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            display: inline-block;
            float: right;
            color: #ff0844;
            font-weight: 700;
            font-size: 13px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preset-btn {
            padding: 12px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            border-color: #ff0844;
            background: #333;
            transform: translateY(-2px);
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff0844, #ff5e3a);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 8, 68, 0.5);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 2px solid #3a3a3a;
        }

        .canvas-container {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            position: relative;
        }

        #renderCanvas {
            width: 100%;
            max-width: 1280px;
            height: auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.9);
        }

        .audio-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            align-items: center;
        }

        .play-btn {
            width: 55px;
            height: 55px;
            background: #ff0844;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 25px rgba(255, 8, 68, 0.6);
        }

        .audio-time {
            flex: 1;
            background: #2a2a2a;
            padding: 12px 18px;
            border-radius: 10px;
            font-family: monospace;
            color: #ff0844;
            font-size: 16px;
            font-weight: 700;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 15px 25px;
            border-radius: 10px;
            border-left: 4px solid #ff0844;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .text-section-collapsed {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .text-section-collapsed:hover {
            background: #333;
        }

        .text-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-section-toggle {
            color: #ff0844;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ WIB PRO - 5 TEXT-EBENEN</h1>
        
        <div class="main-grid">
            <!-- Controls Panel -->
            <div class="controls-panel">
                
                <!-- Background Image Section -->
                <div class="section">
                    <div class="section-title">üñºÔ∏è Hintergrundbild</div>
                    <div class="control-group">
                        <label>Hintergrundbild hochladen</label>
                        <input type="file" id="backgroundImage" accept="image/*">
                    </div>
                    <div class="control-group">
                        <label>Helligkeit <span class="range-value" id="bgBrightnessValue">100%</span></label>
                        <input type="range" id="bgBrightness" min="0" max="200" value="100">
                    </div>
                    <div class="control-group">
                        <label>Unsch√§rfe <span class="range-value" id="bgBlurValue">0px</span></label>
                        <input type="range" id="bgBlur" min="0" max="30" value="0">
                    </div>
                    <div class="control-group">
                        <label>Skalierung <span class="range-value" id="bgScaleValue">100%</span></label>
                        <input type="range" id="bgScale" min="50" max="200" value="100">
                    </div>
                    <div class="control-group">
                        <label>Position X <span class="range-value" id="bgPosXValue">50%</span></label>
                        <input type="range" id="bgPosX" min="0" max="100" value="50">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="bgPosYValue">50%</span></label>
                        <input type="range" id="bgPosY" min="0" max="100" value="50">
                    </div>
                    <div class="control-group">
                        <label>Abdunklung <span class="range-value" id="bgOverlayValue">30%</span></label>
                        <input type="range" id="bgOverlay" min="0" max="100" value="30">
                    </div>
                </div>

                <!-- Text Controls - will be generated dynamically -->
                <div id="textControls"></div>

                <!-- Logo Section -->
                <div class="section">
                    <div class="section-title">üé® Logo (Transparent)</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showLogo">
                        <label for="showLogo">Logo anzeigen</label>
                    </div>
                    <div class="control-group">
                        <label>Logo hochladen (PNG transparent)</label>
                        <input type="file" id="logoImage" accept="image/*">
                    </div>
                    <div class="control-group">
                        <label>Logo Gr√∂√üe <span class="range-value" id="logoSizeValue">150px</span></label>
                        <input type="range" id="logoSize" min="50" max="500" value="150">
                    </div>
                    <div class="control-group">
                        <label>Position X <span class="range-value" id="logoPosXValue">640</span></label>
                        <input type="range" id="logoPosX" min="0" max="1280" value="640">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="logoPosYValue">360</span></label>
                        <input type="range" id="logoPosY" min="0" max="720" value="360">
                    </div>
                    <div class="control-group">
                        <label>Transparenz <span class="range-value" id="logoOpacityValue">80%</span></label>
                        <input type="range" id="logoOpacity" min="0" max="100" value="80">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="logoRotValue">0¬∞</span></label>
                        <input type="range" id="logoRot" min="-180" max="180" value="0">
                    </div>
                </div>

                <!-- Badge Section -->
                <div class="section">
                    <div class="section-title">üè∑Ô∏è Badge</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showBadge" checked>
                        <label for="showBadge">Badge anzeigen</label>
                    </div>
                    <div class="control-group">
                        <label>Badge Text</label>
                        <input type="text" id="badge" value="FREE" maxlength="20">
                    </div>
                    <div class="control-group">
                        <label>Badge Farbe</label>
                        <input type="color" id="badgeColor" value="#ff0844">
                    </div>
                    <div class="control-group">
                        <label>Position X <span class="range-value" id="badgePosXValue">100</span></label>
                        <input type="range" id="badgePosX" min="50" max="300" value="100">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="badgePosYValue">100</span></label>
                        <input type="range" id="badgePosY" min="50" max="300" value="100">
                    </div>
                    <div class="control-group">
                        <label>Gr√∂√üe <span class="range-value" id="badgeSizeValue">1.0</span></label>
                        <input type="range" id="badgeSize" min="0.5" max="2" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="badgeRotValue">-15¬∞</span></label>
                        <input type="range" id="badgeRot" min="-45" max="45" value="-15">
                    </div>
                </div>

                <!-- BPM & Info -->
                <div class="section">
                    <div class="section-title">‚ÑπÔ∏è Beat Info</div>
                    <div class="control-group">
                        <label>BPM</label>
                        <input type="number" id="bpm" value="140" min="60" max="200">
                    </div>
                    <div class="control-group">
                        <label>Zusatztext</label>
                        <input type="text" id="infoText" value="Prod. by WIB" maxlength="50">
                    </div>
                    <div class="control-group">
                        <label>Textgr√∂√üe <span class="range-value" id="infoSizeValue">24px</span></label>
                        <input type="range" id="infoSize" min="12" max="50" value="24">
                    </div>
                    <div class="control-group">
                        <label>Textfarbe</label>
                        <input type="color" id="infoColor" value="#ffffff">
                    </div>
                </div>

                <!-- Animation -->
                <div class="section">
                    <div class="section-title">üé¨ Animation</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableReactive">
                        <label for="enableReactive">Audio-Reaktiv</label>
                    </div>
                    <div class="control-group">
                        <label>Puls-St√§rke <span class="range-value" id="pulseValue">20</span></label>
                        <input type="range" id="pulseStrength" min="0" max="50" value="20">
                    </div>
                </div>

                <!-- Audio -->
                <div class="section">
                    <div class="section-title">üéµ Audio</div>
                    <div class="control-group">
                        <label>Audio hochladen (MP3, WAV)</label>
                        <input type="file" id="audioFile" accept="audio/*">
                    </div>
                </div>

                <!-- Presets -->
                <div class="section">
                    <div class="section-title">üé® Vorlagen</div>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="applyPreset('drill')">Drill</button>
                        <button class="preset-btn" onclick="applyPreset('trap')">Trap</button>
                        <button class="preset-btn" onclick="applyPreset('melodic')">Melodic</button>
                        <button class="preset-btn" onclick="applyPreset('aggressive')">Hard</button>
                        <button class="preset-btn" onclick="applyPreset('balkan')">Balkan</button>
                        <button class="preset-btn" onclick="applyPreset('dark')">Dark</button>
                    </div>
                </div>

                <!-- Export Actions -->
                <div class="section">
                    <button class="action-btn" onclick="downloadImage()">üíæ Als PNG speichern</button>
                    <button class="action-btn secondary" id="recordBtn" onclick="recordVideo()">üé¨ Video aufnehmen (Echtzeit)</button>
                    <p style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4;">
                        üí° Echtzeit-Aufnahme - dauert nur so lange wie das Audio!
                    </p>
                </div>
            </div>

            <!-- Canvas Section -->
            <div class="canvas-container">
                <canvas id="renderCanvas" width="1280" height="720"></canvas>
                
                <div class="audio-controls">
                    <button class="play-btn" id="playBtn" onclick="toggleAudio()">‚ñ∂</button>
                    <div class="audio-time" id="audioTime">0:00 / 0:00</div>
                </div>

                <div class="status-message" id="statusMsg"></div>
            </div>
        </div>
    </div>

    <script>
        // Canvas Setup
        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d');

        // Text layer configurations
        const textDefaults = [
            { text: 'DRILL', size: 120, x: 640, y: 200, spacing: 20, stroke: 6, rot: 0, opacity: 100, color: '#ffffff', strokeColor: '#000000', font: 'Bebas Neue', show: true },
            { text: 'BALKAN', size: 120, x: 640, y: 520, spacing: 20, stroke: 6, rot: 0, opacity: 100, color: '#ffffff', strokeColor: '#000000', font: 'Bebas Neue', show: true },
            { text: '', size: 60, x: 640, y: 360, spacing: 10, stroke: 4, rot: 0, opacity: 100, color: '#ffff00', strokeColor: '#000000', font: 'Bebas Neue', show: false },
            { text: '', size: 40, x: 640, y: 100, spacing: 5, stroke: 3, rot: 0, opacity: 100, color: '#00ff00', strokeColor: '#000000', font: 'Bebas Neue', show: false },
            { text: '', size: 30, x: 640, y: 650, spacing: 3, stroke: 2, rot: 0, opacity: 100, color: '#ff00ff', strokeColor: '#000000', font: 'Bebas Neue', show: false }
        ];

        // Font options
        const fonts = [
            'Bebas Neue', 'Anton', 'Oswald', 'Russo One', 'Black Ops One',
            'Permanent Marker', 'Righteous', 'Staatliches', 'Passion One',
            'Teko', 'Montserrat', 'Impact'
        ];

        // State - generate text state dynamically
        const state = {
            backgroundImage: null,
            bgBrightness: 100,
            bgBlur: 0,
            bgScale: 100,
            bgPosX: 50,
            bgPosY: 50,
            bgOverlay: 30,
            
            // Text layers (dynamically added)
            texts: textDefaults.map(t => ({...t})),
            
            showBadge: true,
            badge: 'FREE',
            badgeColor: '#ff0844',
            badgePosX: 100,
            badgePosY: 100,
            badgeSize: 1.0,
            badgeRot: -15,
            
            showLogo: false,
            logoImage: null,
            logoSize: 150,
            logoPosX: 640,
            logoPosY: 360,
            logoOpacity: 80,
            logoRot: 0,
            
            bpm: 140,
            infoText: 'Prod. by WIB',
            infoSize: 24,
            infoColor: '#ffffff',
            
            enableReactive: false,
            pulseStrength: 20
        };

        // Audio
        const audioElement = new Audio();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        let audioSource = null;
        let isPlaying = false;
        let animationId = null;
        let currentRecorder = null;
        let recordChunks = [];

        // Generate text controls dynamically
        function generateTextControls() {
            const container = document.getElementById('textControls');
            let html = '';
            
            for (let i = 0; i < 5; i++) {
                const num = i + 1;
                html += `
                <div class="section">
                    <div class="section-title">‚úèÔ∏è Text ${num}</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showText${num}" ${state.texts[i].show ? 'checked' : ''}>
                        <label for="showText${num}">Text ${num} anzeigen</label>
                    </div>
                    <div class="control-group">
                        <label>Text</label>
                        <input type="text" id="text${num}" value="${state.texts[i].text}" maxlength="50" placeholder="Text ${num}">
                    </div>
                    <div class="control-group">
                        <label>Schriftart</label>
                        <select id="font${num}">
                            ${fonts.map(f => `<option value="${f}" ${f === state.texts[i].font ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Textfarbe</label>
                        <input type="color" id="textColor${num}" value="${state.texts[i].color}">
                    </div>
                    <div class="control-group">
                        <label>Textgr√∂√üe <span class="range-value" id="fontSize${num}Value">${state.texts[i].size}px</span></label>
                        <input type="range" id="fontSize${num}" min="20" max="300" value="${state.texts[i].size}">
                    </div>
                    <div class="control-group">
                        <label>Position X <span class="range-value" id="textPosX${num}Value">${state.texts[i].x}</span></label>
                        <input type="range" id="textPosX${num}" min="0" max="1280" value="${state.texts[i].x}">
                    </div>
                    <div class="control-group">
                        <label>Position Y <span class="range-value" id="textPosY${num}Value">${state.texts[i].y}</span></label>
                        <input type="range" id="textPosY${num}" min="0" max="720" value="${state.texts[i].y}">
                    </div>
                    <div class="control-group">
                        <label>Buchstabenabstand <span class="range-value" id="letterSpacing${num}Value">${state.texts[i].spacing}px</span></label>
                        <input type="range" id="letterSpacing${num}" min="-10" max="50" value="${state.texts[i].spacing}">
                    </div>
                    <div class="control-group">
                        <label>Kontur Dicke <span class="range-value" id="stroke${num}Value">${state.texts[i].stroke}px</span></label>
                        <input type="range" id="stroke${num}" min="0" max="30" value="${state.texts[i].stroke}">
                    </div>
                    <div class="control-group">
                        <label>Konturfarbe</label>
                        <input type="color" id="strokeColor${num}" value="${state.texts[i].strokeColor}">
                    </div>
                    <div class="control-group">
                        <label>Transparenz <span class="range-value" id="opacity${num}Value">${state.texts[i].opacity}%</span></label>
                        <input type="range" id="opacity${num}" min="0" max="100" value="${state.texts[i].opacity}">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="rotation${num}Value">${state.texts[i].rot}¬∞</span></label>
                        <input type="range" id="rotation${num}" min="-180" max="180" value="${state.texts[i].rot}">
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        // Initialize text controls
        generateTextControls();

        // Setup all event listeners
        function setupEventListeners() {
            // Background controls
            document.getElementById('backgroundImage').addEventListener('change', handleBackgroundUpload);
            document.getElementById('bgBrightness').addEventListener('input', e => updateAndRender('bgBrightness', parseInt(e.target.value), '%'));
            document.getElementById('bgBlur').addEventListener('input', e => updateAndRender('bgBlur', parseInt(e.target.value), 'px'));
            document.getElementById('bgScale').addEventListener('input', e => updateAndRender('bgScale', parseInt(e.target.value), '%'));
            document.getElementById('bgPosX').addEventListener('input', e => updateAndRender('bgPosX', parseInt(e.target.value), '%'));
            document.getElementById('bgPosY').addEventListener('input', e => updateAndRender('bgPosY', parseInt(e.target.value), '%'));
            document.getElementById('bgOverlay').addEventListener('input', e => updateAndRender('bgOverlay', parseInt(e.target.value), '%'));

            // Text controls for all 5 layers
            for (let i = 0; i < 5; i++) {
                const num = i + 1;
                document.getElementById(`showText${num}`).addEventListener('change', e => { state.texts[i].show = e.target.checked; render(); });
                document.getElementById(`text${num}`).addEventListener('input', e => { state.texts[i].text = e.target.value.toUpperCase(); render(); });
                document.getElementById(`font${num}`).addEventListener('change', e => { state.texts[i].font = e.target.value; render(); });
                document.getElementById(`textColor${num}`).addEventListener('input', e => { state.texts[i].color = e.target.value; render(); });
                document.getElementById(`fontSize${num}`).addEventListener('input', e => updateTextAndRender(i, 'size', parseInt(e.target.value), 'px'));
                document.getElementById(`textPosX${num}`).addEventListener('input', e => updateTextAndRender(i, 'x', parseInt(e.target.value)));
                document.getElementById(`textPosY${num}`).addEventListener('input', e => updateTextAndRender(i, 'y', parseInt(e.target.value)));
                document.getElementById(`letterSpacing${num}`).addEventListener('input', e => updateTextAndRender(i, 'spacing', parseInt(e.target.value), 'px'));
                document.getElementById(`stroke${num}`).addEventListener('input', e => updateTextAndRender(i, 'stroke', parseInt(e.target.value), 'px'));
                document.getElementById(`strokeColor${num}`).addEventListener('input', e => { state.texts[i].strokeColor = e.target.value; render(); });
                document.getElementById(`opacity${num}`).addEventListener('input', e => updateTextAndRender(i, 'opacity', parseInt(e.target.value), '%'));
                document.getElementById(`rotation${num}`).addEventListener('input', e => updateTextAndRender(i, 'rot', parseInt(e.target.value), '¬∞'));
            }

            // Logo controls
            document.getElementById('logoImage').addEventListener('change', handleLogoUpload);
            document.getElementById('showLogo').addEventListener('change', e => { state.showLogo = e.target.checked; render(); });
            document.getElementById('logoSize').addEventListener('input', e => updateAndRender('logoSize', parseInt(e.target.value), 'px'));
            document.getElementById('logoPosX').addEventListener('input', e => updateAndRender('logoPosX', parseInt(e.target.value)));
            document.getElementById('logoPosY').addEventListener('input', e => updateAndRender('logoPosY', parseInt(e.target.value)));
            document.getElementById('logoOpacity').addEventListener('input', e => updateAndRender('logoOpacity', parseInt(e.target.value), '%'));
            document.getElementById('logoRot').addEventListener('input', e => updateAndRender('logoRot', parseInt(e.target.value), '¬∞'));

            // Badge controls
            document.getElementById('showBadge').addEventListener('change', e => { state.showBadge = e.target.checked; render(); });
            document.getElementById('badge').addEventListener('input', e => { state.badge = e.target.value.toUpperCase(); render(); });
            document.getElementById('badgeColor').addEventListener('input', e => { state.badgeColor = e.target.value; render(); });
            document.getElementById('badgePosX').addEventListener('input', e => updateAndRender('badgePosX', parseInt(e.target.value)));
            document.getElementById('badgePosY').addEventListener('input', e => updateAndRender('badgePosY', parseInt(e.target.value)));
            document.getElementById('badgeSize').addEventListener('input', e => { state.badgeSize = parseFloat(e.target.value); document.getElementById('badgeSizeValue').textContent = state.badgeSize.toFixed(1); render(); });
            document.getElementById('badgeRot').addEventListener('input', e => updateAndRender('badgeRot', parseInt(e.target.value), '¬∞'));

            // Info controls
            document.getElementById('bpm').addEventListener('input', e => { state.bpm = parseInt(e.target.value); render(); });
            document.getElementById('infoText').addEventListener('input', e => { state.infoText = e.target.value; render(); });
            document.getElementById('infoSize').addEventListener('input', e => updateAndRender('infoSize', parseInt(e.target.value), 'px'));
            document.getElementById('infoColor').addEventListener('input', e => { state.infoColor = e.target.value; render(); });

            // Animation controls
            document.getElementById('enableReactive').addEventListener('change', e => { state.enableReactive = e.target.checked; if (state.enableReactive && isPlaying) render(); });
            document.getElementById('pulseStrength').addEventListener('input', e => { state.pulseStrength = parseInt(e.target.value); document.getElementById('pulseValue').textContent = state.pulseStrength; });

            // Audio
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
        }

        function updateAndRender(key, value, suffix = '') {
            state[key] = value;
            document.getElementById(`${key}Value`).textContent = value + suffix;
            render();
        }

        function updateTextAndRender(index, key, value, suffix = '') {
            state.texts[index][key] = value;
            const num = index + 1;
            const keyMap = { size: 'fontSize', x: 'textPosX', y: 'textPosY', spacing: 'letterSpacing', opacity: 'opacity', rot: 'rotation', stroke: 'stroke' };
            const elemKey = keyMap[key] || key;
            document.getElementById(`${elemKey}${num}Value`).textContent = value + suffix;
            render();
        }

        // File handlers
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.backgroundImage = img;
                    render();
                    showStatus('‚úÖ Hintergrundbild geladen!');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.logoImage = img;
                    state.showLogo = true;
                    document.getElementById('showLogo').checked = true;
                    render();
                    showStatus('‚úÖ Logo geladen!');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleAudioUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            audioElement.src = url;
            if (audioSource) audioSource.disconnect();
            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);
            audioElement.addEventListener('timeupdate', updateTime);
            audioElement.addEventListener('loadedmetadata', updateTime);
            showStatus('‚úÖ Audio geladen!');
        }

        function updateTime() {
            const current = formatTime(audioElement.currentTime);
            const duration = formatTime(audioElement.duration || 0);
            document.getElementById('audioTime').textContent = `${current} / ${duration}`;
        }

        // Render function
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let bassLevel = 0;
            if (state.enableReactive && isPlaying) {
                analyser.getByteFrequencyData(dataArray);
                const bass = dataArray.slice(0, 10);
                bassLevel = bass.reduce((a, b) => a + b, 0) / bass.length / 255;
            }

            // Draw background
            if (state.backgroundImage) {
                ctx.save();
                let filterString = '';
                if (state.bgBrightness !== 100) filterString += `brightness(${state.bgBrightness}%)`;
                if (state.bgBlur > 0) filterString += ` blur(${state.bgBlur}px)`;
                if (filterString) ctx.filter = filterString;

                const scale = state.bgScale / 100;
                const imgWidth = state.backgroundImage.width;
                const imgHeight = state.backgroundImage.height;
                const canvasRatio = canvas.width / canvas.height;
                const imgRatio = imgWidth / imgHeight;

                let drawWidth, drawHeight;
                if (imgRatio > canvasRatio) {
                    drawHeight = canvas.height * scale;
                    drawWidth = drawHeight * imgRatio;
                } else {
                    drawWidth = canvas.width * scale;
                    drawHeight = drawWidth / imgRatio;
                }

                const offsetX = (canvas.width - drawWidth) * (state.bgPosX / 100);
                const offsetY = (canvas.height - drawHeight) * (state.bgPosY / 100);

                ctx.drawImage(state.backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                ctx.filter = 'none';
                ctx.restore();

                if (state.bgOverlay > 0) {
                    ctx.fillStyle = `rgba(0, 0, 0, ${state.bgOverlay / 100})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#1a1a1a');
                gradient.addColorStop(1, '#0a0a0a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Draw all texts
            state.texts.forEach((t, i) => {
                if (t.show && t.text) {
                    drawText(t.text, t.font, t.size, t.color, t.x, t.y, t.spacing, t.stroke, t.strokeColor, t.opacity, t.rot, bassLevel);
                }
            });

            // Draw Badge (NO animation)
            if (state.showBadge && state.badge) {
                drawBadge();
            }

            // Draw Logo (NO animation)
            if (state.showLogo && state.logoImage) {
                drawLogo();
            }

            // Draw Info
            drawInfo();

            if (state.enableReactive && isPlaying) {
                animationId = requestAnimationFrame(render);
            }
        }

        function drawText(text, font, size, color, posX, posY, spacing, strokeWidth, strokeColor, opacity, rotation, bassLevel) {
            if (!text) return;

            ctx.save();
            
            const pulseSize = state.enableReactive && bassLevel > 0 ? size + (bassLevel * state.pulseStrength) : size;

            ctx.font = `900 ${pulseSize}px "${font}"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.globalAlpha = opacity / 100;

            if (rotation !== 0) {
                ctx.translate(posX, posY);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.translate(-posX, -posY);
            }

            const metrics = ctx.measureText(text);
            const totalSpacing = (text.length - 1) * spacing;
            const totalWidth = metrics.width + totalSpacing;
            let x = posX - (totalWidth / 2);

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charMetrics = ctx.measureText(char);

                if (strokeWidth > 0) {
                    ctx.strokeStyle = strokeColor;
                    ctx.lineWidth = strokeWidth;
                    ctx.lineJoin = 'round';
                    ctx.strokeText(char, x + charMetrics.width / 2, posY);
                }

                ctx.fillStyle = color;
                ctx.fillText(char, x + charMetrics.width / 2, posY);

                x += charMetrics.width + spacing;
            }

            ctx.restore();
        }

        function drawBadge() {
            ctx.save();
            ctx.translate(state.badgePosX, state.badgePosY);
            ctx.rotate(state.badgeRot * Math.PI / 180);
            ctx.scale(state.badgeSize, state.badgeSize);

            ctx.fillStyle = state.badgeColor;
            ctx.beginPath();
            ctx.roundRect(-60, -25, 120, 50, 8);
            ctx.fill();

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(state.badge, 0, 0);

            ctx.restore();
        }

        function drawLogo() {
            if (!state.logoImage) return;
            ctx.save();
            ctx.globalAlpha = state.logoOpacity / 100;
            ctx.translate(state.logoPosX, state.logoPosY);
            ctx.rotate(state.logoRot * Math.PI / 180);
            const logoW = state.logoSize;
            const logoH = (state.logoImage.height / state.logoImage.width) * logoW;
            ctx.drawImage(state.logoImage, -logoW / 2, -logoH / 2, logoW, logoH);
            ctx.restore();
        }

        function drawInfo() {
            ctx.fillStyle = state.infoColor;
            ctx.font = `bold ${state.infoSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText(`${state.bpm} BPM`, 40, canvas.height - 40);
            ctx.textAlign = 'right';
            ctx.fillText(state.infoText, canvas.width - 40, canvas.height - 40);
        }

        // Audio controls
        async function toggleAudio() {
            if (!audioElement.src) {
                showStatus('‚ùå Bitte zuerst Audio hochladen!');
                return;
            }

            if (isPlaying) {
                audioElement.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                render();
            } else {
                try {
                    if (audioContext.state === 'suspended') await audioContext.resume();
                    await audioElement.play();
                    isPlaying = true;
                    document.getElementById('playBtn').textContent = '‚è∏';
                    if (state.enableReactive) render();
                } catch (error) {
                    console.error('Play error:', error);
                    showStatus('‚ùå Fehler beim Abspielen');
                    isPlaying = false;
                    document.getElementById('playBtn').textContent = '‚ñ∂';
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Export functions
        function downloadImage() {
            if (animationId) cancelAnimationFrame(animationId);
            render();
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `WIB_${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
                showStatus('‚úÖ PNG gespeichert!');
                if (state.enableReactive && isPlaying) render();
            });
        }

        async function recordVideo() {
            if (!audioElement.src) {
                showStatus('‚ùå Bitte zuerst Audio hochladen!');
                return;
            }

            const recordBtn = document.getElementById('recordBtn');

            if (currentRecorder && currentRecorder.state === 'recording') {
                currentRecorder.stop();
                audioElement.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
                recordBtn.textContent = 'üé¨ Video aufnehmen (Echtzeit)';
                recordBtn.classList.remove('secondary');
                showStatus('‚è≥ Video wird finalisiert...');
                return;
            }

            try {
                const canvasStream = canvas.captureStream(60);
                const audioDestination = audioContext.createMediaStreamDestination();
                audioSource.connect(audioDestination);

                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioDestination.stream.getAudioTracks()
                ]);

                recordChunks = [];
                currentRecorder = new MediaRecorder(combinedStream, {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 10000000
                });

                currentRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) recordChunks.push(event.data);
                };

                currentRecorder.onstop = () => {
                    const blob = new Blob(recordChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `WIB_${Date.now()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);

                    recordBtn.disabled = false;
                    recordBtn.textContent = 'üé¨ Video aufnehmen (Echtzeit)';
                    recordBtn.classList.remove('secondary');
                    showStatus('‚úÖ Video exportiert! (WebM - mit VLC als MP4 speichern)');
                    currentRecorder = null;
                };

                currentRecorder.start(100);

                audioElement.currentTime = 0;
                if (audioContext.state === 'suspended') await audioContext.resume();
                await audioElement.play();
                isPlaying = true;
                document.getElementById('playBtn').textContent = '‚è∏';

                state.enableReactive = true;
                document.getElementById('enableReactive').checked = true;
                render();

                recordBtn.textContent = '‚èπ Export stoppen';
                recordBtn.classList.add('secondary');
                showStatus('üî¥ Aufnahme l√§uft - Echtzeit!');

                audioElement.onended = () => {
                    if (currentRecorder && currentRecorder.state === 'recording') {
                        currentRecorder.stop();
                        isPlaying = false;
                        document.getElementById('playBtn').textContent = '‚ñ∂';
                    }
                };

            } catch (error) {
                console.error('Export error:', error);
                showStatus('‚ùå Fehler: ' + error.message);
                recordBtn.disabled = false;
                recordBtn.textContent = 'üé¨ Video aufnehmen (Echtzeit)';
                currentRecorder = null;
            }
        }

        function showStatus(message) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = message;
            statusMsg.style.display = 'block';
            setTimeout(() => {
                statusMsg.style.display = 'none';
            }, 4000);
        }

        // Presets
        const presets = {
            drill: { texts: [{ text: 'DRILL', show: true }, { text: 'BALKAN', show: true }], badge: 'FREE', badgeColor: '#ff0844', bpm: 140 },
            trap: { texts: [{ text: 'TRAP', show: true }, { text: 'BEAT', show: true, color: '#9d00ff' }], badge: 'FREE', badgeColor: '#9d00ff', bpm: 145 },
            melodic: { texts: [{ text: 'MELODIC', show: true, color: '#00d4ff' }, { text: 'VIBES', show: true, color: '#7b2cbf' }], badge: 'FREE', badgeColor: '#00d4ff', bpm: 130 },
            aggressive: { texts: [{ text: 'HARD', show: true }, { text: 'BEAT', show: true, color: '#ff0000' }], badge: 'NEW', badgeColor: '#ff0000', bpm: 150 },
            balkan: { texts: [{ text: 'DRILL', show: true }, { text: 'BALKAN', show: true, color: '#0066ff' }], badge: 'FREE', badgeColor: '#ff0000', bpm: 140 },
            dark: { texts: [{ text: 'DARK', show: true }, { text: 'BEAT', show: true, color: '#999999' }], badge: 'NEW', badgeColor: '#4a4a4a', bpm: 135 }
        };

        function applyPreset(name) {
            const preset = presets[name];
            
            preset.texts.forEach((t, i) => {
                if (t.text !== undefined) {
                    state.texts[i].text = t.text;
                    document.getElementById(`text${i + 1}`).value = t.text;
                }
                if (t.show !== undefined) {
                    state.texts[i].show = t.show;
                    document.getElementById(`showText${i + 1}`).checked = t.show;
                }
                if (t.color !== undefined) {
                    state.texts[i].color = t.color;
                    document.getElementById(`textColor${i + 1}`).value = t.color;
                }
            });

            if (preset.badge) {
                state.badge = preset.badge;
                document.getElementById('badge').value = preset.badge;
            }
            if (preset.badgeColor) {
                state.badgeColor = preset.badgeColor;
                document.getElementById('badgeColor').value = preset.badgeColor;
            }
            if (preset.bpm) {
                state.bpm = preset.bpm;
                document.getElementById('bpm').value = preset.bpm;
            }

            render();
            showStatus(`‚úÖ Vorlage "${name}" angewendet!`);
        }

        // Initialize
        setupEventListeners();
        render();
    </script>
</body>
</html>
